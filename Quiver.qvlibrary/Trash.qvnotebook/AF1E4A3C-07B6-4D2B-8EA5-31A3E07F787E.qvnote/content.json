{
  "title": "Untitled Note",
  "cells": [
    {
      "type": "text",
      "data": "<div>-- commission对应的有效settlemnt条数表</div><div>DROP TABLE IF EXISTS fdd_settlement_center.`commission_with_settlements`;</div><div>CREATE TABLE fdd_settlement_center.`commission_with_settlements` (</div><div>&nbsp; `commission_id` bigint(11) DEFAULT NULL,</div><div>&nbsp; `order_id` bigint(11) DEFAULT NULL,</div><div>&nbsp; `settlement_count` int(11) DEFAULT NULL,</div><div>&nbsp; KEY `k_commission_id` (`commission_id`) USING BTREE</div><div>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div>TRUNCATE fdd_settlement_center.commission_with_settlements;</div><div><br></div><div>-- 新旧commission影射表</div><div>DROP TABLE IF EXISTS fdd_settlement_center.`commission_id_map`;</div><div>CREATE TABLE fdd_settlement_center.`commission_id_map` (</div><div>&nbsp; `old_commission_id` bigint(11) DEFAULT NULL,</div><div>&nbsp; `new_commission_id` bigint(11) DEFAULT NULL,</div><div>&nbsp; `remark` varchar(50) DEFAULT NULL</div><div>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div><br></div><div>-- commission id临时表</div><div>DROP TABLE IF EXISTS fdd_settlement_center.`commission_id_temp`;</div><div>CREATE TABLE fdd_settlement_center.`commission_id_temp` (</div><div>&nbsp; `commission_id` bigint(11) DEFAULT NULL,</div><div>&nbsp; `remark` varchar(50) DEFAULT NULL</div><div>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div><br></div><div>&nbsp;ALTER TABLE fdd_settlement_center.t_sc_commission DROP COLUMN transfer_flag; &nbsp;</div><div>&nbsp;ALTER TABLE fdd_settlement_center.t_sc_commission Add COLUMN transfer_flag INT NOT NULL DEFAULT 0; -- 0 初始化 &nbsp;1 commission和relation金额不一致 2 已处理</div><div><br></div><div>-- 给数据不一致的commission打标记 129</div><div>TRUNCATE fdd_settlement_center.commission_id_temp;</div><div>INSERT INTO fdd_settlement_center.`commission_id_temp` (commission_id)</div><div>SELECT</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.pid</div><div>FROM</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>fdd_settlement_center.t_sc_commission commission,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>(SELECT</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>commission_id, sum(relation.amount) as amount</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>FROM</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>fdd_settlement_center.t_sc_relation relation,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>fdd_settlement_center.t_sc_settlement settlement</div><div>&nbsp;<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>WHERE</div><div>&nbsp;<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>relation.del_flag = 0</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>AND settlement.del_flag = 0</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>AND relation.settlement_id = settlement.pid</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>AND settlement.`status` IN (90)</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>GROUP BY commission_id) AS relation_amount</div><div>WHERE</div><div>&nbsp;<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.del_flag = 0</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND relation_amount.commission_id = commission.pid</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND relation_amount.amount &lt;&gt; commission.paid_amt - commission.recover_amt;</div><div>UPDATE fdd_settlement_center.t_sc_commission</div><div>SET transfer_flag = 1</div><div>WHERE pid IN (SELECT commission_id FROM fdd_settlement_center.commission_id_temp);</div><div><br></div><div>-- 数据 &nbsp;</div><div>-- SELECT count(1) FROM fdd_settlement_center.t_sc_commission commission WHERE commission.transfer_flag = 0;</div><div><br></div><div>-- 垫佣 157</div><div>-- SELECT count(1) FROM fdd_settlement_center.t_sc_commission commission WHERE commission.is_prepay = 1 AND commission.transfer_flag = 0;</div><div><br></div><div>-- 非垫佣 156045</div><div>-- SELECT count(1) FROM fdd_settlement_center.t_sc_commission commission WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0;</div><div><br></div><div>-- 中间表</div><div>-- 有有效settlment &amp;&amp; 非垫佣 114020</div><div>TRUNCATE fdd_settlement_center.commission_with_settlements;</div><div>INSERT INTO<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>fdd_settlement_center.commission_with_settlements</div><div>(</div><div>commission_id,</div><div>order_id,</div><div>settlement_count</div><div>)</div><div>SELECT DISTINCT</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>relation.commission_id, relation.order_id, count(relation.settlement_id) AS total</div><div>FROM</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>fdd_settlement_center.t_sc_relation relation,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>fdd_settlement_center.t_sc_commission commission,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>fdd_settlement_center.t_sc_settlement settlement</div><div>WHERE relation.commission_id = commission.pid AND commission.is_prepay &lt;&gt; 1 AND relation.del_flag = 0 AND settlement.del_flag = 0 AND relation.settlement_id = settlement.pid AND settlement.`status` IN (10, 20, 90) AND commission.transfer_flag = 0</div><div>GROUP BY relation.commission_id, relation.order_id;</div><div><br></div><div>SELECT count(commission_id)</div><div>FROM fdd_settlement_center.commission_with_settlements;</div><div><br></div><div>-- 没有settlement &amp;&amp; 非垫佣 42154</div><div>TRUNCATE `fdd_nh_tc_v2`.`t_tc_settlement_commission`;</div><div>INSERT INTO `fdd_nh_tc_v2`.`t_tc_settlement_commission` (</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`commission_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`order_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`trade_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`pay_amt`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`merchant_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`operate_type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`agent_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_name`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_mobile`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`company_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`remark`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`status_flag`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`last_update_time`</div><div>) SELECT</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`pid`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`order_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>NULL,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CASE `source_tag`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 10 THEN 3</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 20 THEN 3</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>ELSE `type`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`pay_amt`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`merchant_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`operate_type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`agent_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_name`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_mobile`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`company_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`remark`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CASE `del_flag`&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 0 THEN 1</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 1 THEN 0&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`last_update_time`</div><div>FROM `fdd_settlement_center`.`t_sc_commission` commission</div><div>WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0 AND NOT EXISTS (SELECT * FROM fdd_settlement_center.commission_with_settlements cws WHERE cws.commission_id = commission.pid);</div><div>UPDATE `fdd_settlement_center`.`t_sc_commission` commission SET commission.transfer_flag = 2 WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0 AND NOT EXISTS (SELECT * FROM fdd_settlement_center.commission_with_settlements cws WHERE cws.commission_id = commission.pid);</div><div><br></div><div>-- 结清且只有一条settlement 110842</div><div>INSERT INTO `fdd_nh_tc_v2`.`t_tc_settlement_commission` (</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`commission_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`order_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`trade_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`pay_amt`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`merchant_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`operate_type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`agent_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_name`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`customer_mobile`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`store_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`project_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`company_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`remark`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`status_flag`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`last_update_time`</div><div>) SELECT</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`pid`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`order_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>NULL,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CASE commission.`source_tag`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 10 THEN 3</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 20 THEN 3</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>ELSE commission.`type`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`pay_amt`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`store_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`merchant_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`operate_type`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`agent_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`customer_name`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`customer_mobile`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`project_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`store_city_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`project_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`company_id`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission.`remark`,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CASE `del_flag`&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 0 THEN 1</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHEN 1 THEN 0&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>`last_update_time`</div><div>FROM `fdd_settlement_center`.`t_sc_commission` commission,</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span> fdd_settlement_center.commission_with_settlements cws</div><div>WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0 AND commission.paid_amt = commission.total_pay_amt + commission.recover_amt</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND commission.pid = cws.commission_id</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND cws.settlement_count = 1;</div><div><br></div><div>UPDATE `fdd_settlement_center`.`t_sc_commission` commission</div><div>SET commission.transfer_flag = 2</div><div>WHERE EXISTS (</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>SELECT cws1.commission_id</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>FROM fdd_settlement_center.commission_with_settlements cws1</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>WHERE commission.is_prepay &lt;&gt; 1 AND commission.paid_amt = commission.total_pay_amt + commission.recover_amt</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND commission.pid = cws1.commission_id</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND cws1.settlement_count = 1</div><div>);</div><div><br></div><div><br></div><div>-- 结清有多条settlement 510</div><div>delimiter $$</div><div>DROP PROCEDURE IF EXISTS transfer_settled_commission_has_setllements $$</div><div>CREATE PROCEDURE transfer_settled_commission_has_setllements()</div><div>BEGIN</div><div>&nbsp; &nbsp; -- 变量</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 循环结束标志</div><div>&nbsp; &nbsp; DECLARE done int;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- commission</div><div>&nbsp; &nbsp; DECLARE _commission_id BIGINT(20);</div><div>&nbsp; &nbsp; DECLARE _order_id BIGINT(20);</div><div>&nbsp; &nbsp; DECLARE _type int(2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _total_pay_amt DECIMAL(10,2);</div><div>&nbsp; &nbsp; DECLARE _pay_amt DECIMAL(10,2);</div><div>&nbsp; &nbsp; DECLARE _store_id int(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _merchant_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _operate_type INT (1);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _agent_id INT (11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _customer_name VARCHAR(128);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _customer_mobile VARCHAR(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _project_city_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _store_city_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _project_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _company_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _remark VARCHAR(1000);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _status_flag int(2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _last_update_time TIMESTAMP;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- relation</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_settlement_id BIGINT(20);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_commission_id BIGINT(20);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_order_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_amount DECIMAL(10,2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_create_time datetime;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_last_update_time TIMESTAMP;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_del_flag TINYINT(1);</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 临时pk</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _temp_pk BIGINT(20);</div><div><br></div><div>&nbsp; &nbsp; -- 定义游标</div><div>&nbsp; &nbsp; DECLARE commission_cursor CURSOR FOR SELECT `pid`,commission.`order_id`,CASE `source_tag` WHEN 10 THEN 3 WHEN 20 THEN 3 ELSE `type` END,`pay_amt`,`store_id`,`merchant_id`,`operate_type`,`agent_id`,`customer_name`,`customer_mobile`,`project_city_id`,`store_city_id`,`project_id`,`company_id`,`remark`,CASE `del_flag` WHEN 0 THEN 1 WHEN 1 THEN 0 END,`last_update_time`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>FROM `fdd_settlement_center`.`t_sc_commission` commission, fdd_settlement_center.commission_with_settlements cws</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0 &nbsp;AND commission.paid_amt = commission.total_pay_amt + commission.recover_amt<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND commission.pid = cws.commission_id AND cws.settlement_count &gt; 1;</div><div>&nbsp; &nbsp; DECLARE relation_cursor CURSOR FOR SELECT `settlement_id`, `commission_id`, `order_id`, `amount`, `create_time`, `last_update_time`, `del_flag` FROM `fdd_settlement_center`.`t_sc_relation` relation WHERE relation.commission_id = _commission_id AND relation.del_flag = 0;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 打开commission游标</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>OPEN commission_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- commission循环</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission_loop:LOOP</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>FETCH commission_cursor INTO _commission_id,_order_id,_type,_pay_amt,_store_id,_merchant_id,_operate_type,_agent_id,_customer_name,_customer_mobile,_project_city_id,_store_city_id,_project_id,_company_id,_remark,_status_flag,_last_update_time;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>if done=1 THEN</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>LEAVE commission_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>END IF;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>-- 打开relation游标</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>OPEN relation_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>-- relation循环</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>relation_loop:LOOP</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>FETCH relation_cursor INTO _r_settlement_id, _r_commission_id, _r_order_id, _r_amount, _r_create_time, _r_last_update_time, _r_del_flag;&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>if done = 1 THEN</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t\t</span>LEAVE relation_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>END IF;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 插入新commission</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>INSERT INTO `fdd_nh_tc_v2`.`t_tc_settlement_commission` (`order_id`,`type`,`pay_amt`,`store_id`,`merchant_id`,`operate_type`,`agent_id`,`customer_name`,`customer_mobile`,`project_city_id`,`store_city_id`,`project_id`,`company_id`,`remark`,`status_flag`,`last_update_time`)</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t\t</span>VALUES(_order_id,_type,_r_amount,_store_id,_merchant_id,_operate_type,_agent_id,_customer_name,_customer_mobile,_project_city_id,_store_city_id,_project_id,_company_id,_remark,_status_flag,_r_last_update_time);</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 更新relation中的commission_id</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>SELECT LAST_INSERT_ID() INTO _temp_pk;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 插入commission_id新旧影射</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>INSERT INTO fdd_settlement_center.`commission_id_map` (`old_commission_id`, `new_commission_id`) VALUES(_r_commission_id, _temp_pk);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>UPDATE `fdd_nh_tc_v2`.`t_tc_settlement_relation` SET commission_id = _temp_pk WHERE commission_id = _r_commission_id AND settlement_id = _r_settlement_id;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>END LOOP relation_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>CLOSE relation_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>SET done = 0;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>UPDATE `fdd_settlement_center`.`t_sc_commission` commission SET commission.transfer_flag = 2 WHERE pid = _commission_id;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END LOOP commission_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CLOSE commission_cursor;</div><div>END $$</div><div><br></div><div><br></div><div>-- 非结清settlement 2550</div><div>delimiter $$</div><div>DROP PROCEDURE IF EXISTS transfer_unsettled_commission_has_setllements $$</div><div>CREATE PROCEDURE transfer_unsettled_commission_has_setllements()</div><div>BEGIN</div><div>&nbsp; &nbsp; -- 变量</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 循环结束标志</div><div>&nbsp; &nbsp; DECLARE done int;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- commission</div><div>&nbsp; &nbsp; DECLARE _commission_id BIGINT(20);</div><div>&nbsp; &nbsp; DECLARE _order_id BIGINT(20);</div><div>&nbsp; &nbsp; DECLARE _type int(2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _total_pay_amt DECIMAL(10,2);</div><div>&nbsp; &nbsp; DECLARE _pay_amt DECIMAL(10,2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _paid_amt DECIMAL(10,2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _recover_amt DECIMAL(10,2);</div><div>&nbsp; &nbsp; DECLARE _store_id int(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _merchant_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _operate_type INT (1);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _agent_id INT (11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _customer_name VARCHAR(128);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _customer_mobile VARCHAR(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _project_city_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _store_city_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _project_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _company_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _remark VARCHAR(1000);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _status_flag int(2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _last_update_time TIMESTAMP;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- relation</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_settlement_id BIGINT(20);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_commission_id BIGINT(20);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_order_id INT(11);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_amount DECIMAL(10,2);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_create_time datetime;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_last_update_time TIMESTAMP;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _r_del_flag TINYINT(1);</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 临时pk</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _temp_pk BIGINT(20);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE _amount_left DECIMAL(10,2);</div><div><br></div><div>&nbsp; &nbsp; -- 定义游标</div><div>&nbsp; &nbsp; DECLARE commission_cursor CURSOR FOR SELECT `pid`,commission.`order_id`,CASE `source_tag` WHEN 10 THEN 3 WHEN 20 THEN 3 ELSE `type` END,`pay_amt`,`paid_amt`,`recover_amt`,`store_id`,`merchant_id`,`operate_type`,`agent_id`,`customer_name`,`customer_mobile`,`project_city_id`,`store_city_id`,`project_id`,`company_id`,`remark`,CASE `del_flag` WHEN 0 THEN 1 WHEN 1 THEN 0 END,`last_update_time`</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>FROM `fdd_settlement_center`.`t_sc_commission` commission, fdd_settlement_center.commission_with_settlements cws</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>WHERE commission.is_prepay &lt;&gt; 1 AND commission.transfer_flag = 0 &nbsp;AND commission.paid_amt &lt;&gt; commission.total_pay_amt + commission.recover_amt<span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>AND commission.pid = cws.commission_id;</div><div>&nbsp; &nbsp; DECLARE relation_cursor CURSOR FOR SELECT `settlement_id`, `commission_id`, `order_id`, `amount`, `create_time`, `last_update_time`, `del_flag` FROM `fdd_settlement_center`.`t_sc_relation` relation WHERE relation.commission_id = _commission_id AND relation.del_flag = 0;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- 打开commission游标</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>OPEN commission_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>-- commission循环</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>commission_loop:LOOP</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>FETCH commission_cursor INTO _commission_id,_order_id,_type,_pay_amt,_paid_amt,_recover_amt,_store_id,_merchant_id,_operate_type,_agent_id,_customer_name,_customer_mobile,_project_city_id,_store_city_id,_project_id,_company_id,_remark,_status_flag,_last_update_time;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>if done=1 THEN</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>LEAVE commission_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>END IF;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>-- 打开relation游标</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>OPEN relation_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>-- relation循环</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>relation_loop:LOOP</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>FETCH relation_cursor INTO _r_settlement_id, _r_commission_id, _r_order_id, _r_amount, _r_create_time, _r_last_update_time, _r_del_flag;&nbsp;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>if done = 1 THEN</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t\t</span>LEAVE relation_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>END IF;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 插入新commission</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>INSERT INTO `fdd_nh_tc_v2`.`t_tc_settlement_commission` (`order_id`,`type`,`pay_amt`,`store_id`,`merchant_id`,`operate_type`,`agent_id`,`customer_name`,`customer_mobile`,`project_city_id`,`store_city_id`,`project_id`,`company_id`,`remark`,`status_flag`,`last_update_time`)</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t\t</span>VALUES(_order_id,_type,_r_amount,_store_id,_merchant_id,_operate_type,_agent_id,_customer_name,_customer_mobile,_project_city_id,_store_city_id,_project_id,_company_id,_remark,_status_flag,_r_last_update_time);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 更新relation中的commission_id</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>SELECT LAST_INSERT_ID() INTO _temp_pk;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>-- 插入commission_id新旧影射</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>INSERT INTO fdd_settlement_center.`commission_id_map` (`old_commission_id`, `new_commission_id`) VALUES(_r_commission_id, _temp_pk);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>UPDATE `fdd_nh_tc_v2`.`t_tc_settlement_relation` SET commission_id = _temp_pk WHERE commission_id = _r_commission_id AND settlement_id = _r_settlement_id;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>END LOOP relation_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>CLOSE relation_cursor;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>SET done = 0;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>SET _amount_left = 0;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>SET _amount_left = _pay_amt + _recover_amt - _paid_amt;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>IF _amount_left = 0.00 THEN</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t</span>INSERT INTO `fdd_nh_tc_v2`.`t_tc_settlement_commission` (`order_id`,`type`,`pay_amt`,`store_id`,`merchant_id`,`operate_type`,`agent_id`,`customer_name`,`customer_mobile`,`project_city_id`,`store_city_id`,`project_id`,`company_id`,`remark`,`status_flag`,`last_update_time`)</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t\t\t</span>VALUES(_order_id,_type,_amount_left,_store_id,_merchant_id,_operate_type,_agent_id,_customer_name,_customer_mobile,_project_city_id,_store_city_id,_project_id,_company_id,_remark,_status_flag,_r_last_update_time);</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>END IF;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t\t</span>UPDATE `fdd_settlement_center`.`t_sc_commission` commission SET commission.transfer_flag = 2 WHERE pid = _commission_id;</div><div><br></div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>END LOOP commission_loop;</div><div><span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>CLOSE commission_cursor;</div><div>END $$</div><div><br></div><div>delimiter $$</div><div>DROP PROCEDURE IF EXISTS sync_commission_trade_id $$</div><div>CREATE PROCEDURE sync_commission_trade_id()</div><div>BEGIN</div><div>&nbsp; &nbsp; #变量</div><div>&nbsp; &nbsp; DECLARE done int;</div><div><br></div><div>&nbsp; &nbsp; DECLARE _pid int(11);</div><div>&nbsp; &nbsp; DECLARE _order_id int(11);</div><div>&nbsp; &nbsp; DECLARE _type int(11);</div><div>&nbsp; &nbsp; DECLARE _store_id int(11);</div><div><br></div><div>&nbsp; &nbsp; DECLARE _trade_id int(11);</div><div><br></div><div>&nbsp; &nbsp; #定义游标</div><div>&nbsp; &nbsp; DECLARE mycursor CURSOR FOR SELECT pid, order_id, store_i, type FROM `fdd_nh_tc_v2`.`t_tc_settlement_commission`;</div><div>&nbsp; &nbsp; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;</div><div><br></div><div>&nbsp; &nbsp; #打开游标</div><div>&nbsp; &nbsp; OPEN mycursor;</div><div>&nbsp; &nbsp; #循环游标</div><div>&nbsp; &nbsp; cursor_loop:loop</div><div>&nbsp; &nbsp; #取数据</div><div>&nbsp; &nbsp; FETCH mycursor INTO &nbsp;_pid, _order_id, _type, _store_id;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; IF done=1 THEN</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEAVE cursor_loop;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; END IF;</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; SET _trade_id = 0;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; SELECT</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ttr.id into _trade_id</div><div>&nbsp; &nbsp; &nbsp; &nbsp; FROM</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; `fdd_nh_tc_v2`.`t_tc_trade` AS ttr</div><div>&nbsp; &nbsp; &nbsp; &nbsp; INNER JOIN `fdd_nh_tc_v2`.t_tc_account AS tta ON tta.user_id = ttr.to_account_id AND account_type = 6</div><div>&nbsp; &nbsp; &nbsp; &nbsp; where ttr.order_id = _order_id and ttr.fee_type = _type and ttr.id is not null;</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; IF _trade_id &gt; 0 THEN</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UPDATE `fdd_nh_tc_v2`.`t_tc_settlement_commission`</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET `trade_id` = _trade_id</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE `pid` = _pid;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; END IF;</div><div><br></div><div>&nbsp; &nbsp; END LOOP;</div><div>&nbsp; &nbsp; CLOSE mycursor;</div><div>END $$</div><div><br></div><div><br></div><div>CALL transfer_settled_commission_has_setllements();</div><div>CALL transfer_unsettled_commission_has_setllements();</div><div>-- CALL sync_commission_trade_id();</div><div><br></div><div>-- DROP TABLE IF EXISTS `commission_with_settlements`;</div><div><br></div>"
    }
  ]
}